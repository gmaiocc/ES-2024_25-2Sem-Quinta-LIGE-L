<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualização de Conexões de Propriedades</title>

    <!-- Estilo externo -->
    <link rel="stylesheet" href="style.css">

    <!-- Inclusão das bibliotecas necessárias -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <h1>Visualização de Conexões de Propriedades</h1>

    <!-- Controles para upload de ficheiro -->
    <div class="controls">
        <input type="file" id="fileInput" accept=".csv">
        <button onclick="processFile()">Gerar Grafo de Propriedades</button>
    </div>

    <!-- Área para exibir o grafo -->
    <div id="mynetwork"></div>

    <script>
        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            // Verifica se um ficheiro foi selecionado
            if (!file) {
                alert("Por favor, selecione um ficheiro CSV.");
                return;
            }

            const reader = new FileReader();

            // Leitura do conteúdo do ficheiro
            reader.onload = function (event) {
                const csvData = event.target.result;

                const testLimit = 50;

                // Envia os dados CSV para o servidor FastAPI
                fetch(`http://127.0.0.1:8000/process_graph?limit=${testLimit}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: csvData })
                })
                .then(response => response.json())
                .then(graphData => {
                    // Verifica se os dados do grafo são válidos
                    if (graphData && graphData.nodes && graphData.edges) {
                        const nodes = new vis.DataSet(graphData.nodes);
                        const edges = new vis.DataSet(graphData.edges);
                        const data = { nodes, edges };

                        const options = {
                            physics: {
                                enabled: true,
                                barnesHut: {
                                    gravitationalConstant: -2000,
                                    centralGravity: 0.2,
                                    springLength: 95,
                                    springConstant: 0.04,
                                    damping: 0.09,
                                    avoidOverlap: 1
                                },
                                solver: 'barnesHut',
                                stabilization: {
                                    iterations: 1000,
                                    updateInterval: 100,
                                    onlyDynamicEdges: false,
                                    fit: true
                                }
                            },
                            layout: {
                                improvedLayout: true
                            },
                            nodes: {
                                size: 10
                            }
                        };

                        // Renderiza o grafo na página
                        const container = document.getElementById('mynetwork');
                        new vis.Network(container, data, options);
                    } else {
                        console.error("Dados inválidos:", graphData);
                        alert("Erro ao gerar grafo.");
                    }
                })
                .catch(error => {
                    console.error('Erro ao processar o ficheiro:', error);
                    alert("Erro ao comunicar com o servidor.");
                });
            };

            reader.readAsText(file);
        }
    </script>
</body>

</html>